<!DOCTYPE html>
<html lang=cn>
<head>
    
        
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel=stylesheet type="text/css" href=https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;normalize.css>
        <link rel=stylesheet type="text/css" href=https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;style.css>
        <title>
    Lin Yinfeng
    - Futures-rs åšæ–‡ Toykio ç¿»è¯‘
</title>
    
</head>
<body>
    
        <header id="header">
            
            
    <div class="header-container container">
        <h1 id="blog-title" class="title"><a href=https:&#x2F;&#x2F;www.linyinfeng.com>Lin Yinfeng</a></h1>
        <nav id="global-nav"><span class="global-nav-item-container"><a class="global-nav-item"
                    href=https:&#x2F;&#x2F;www.linyinfeng.com
                >Home</a></span><span class="global-nav-item-container"><a class="global-nav-item"
                    href=https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;archive
                >Archive</a></span><span class="global-nav-item-container"><a class="global-nav-item"
                    href=https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;links
                >Links</a></span><span class="global-nav-item-container"><a class="global-nav-item"
                    href=https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;status
                >Status</a></span></nav>
    </div>

            
        </header>
        <div id="main-aside-container">
            
    
        
                <aside id="aside">
                    <div id="aside-container">
                        
    
    <div class="toc-container container">
        <h1 class="title toc-title">Table of Contents</h1>
        
    
        <ul class="toc-parent">
                
                <li class="toc-entry">
                    <a href=https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;posts&#x2F;toykio&#x2F;#asynctcpstream>AsyncTcpStream</a>
                    
    

                </li>
                
                <li class="toc-entry">
                    <a href=https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;posts&#x2F;toykio&#x2F;#asyncread-he-asyncwrite>AsyncRead å’Œ AsyncWrite</a>
                    
    

                </li>
                
                <li class="toc-entry">
                    <a href=https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;posts&#x2F;toykio&#x2F;#shi-jian-xun-huan>äº‹ä»¶å¾ªç¯</a>
                    
    

                </li>
                
                <li class="toc-entry">
                    <a href=https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;posts&#x2F;toykio&#x2F;#yi-ge-future-de-yi-sheng>ä¸€ä¸ª future çš„ä¸€ç”Ÿ</a>
                    
    

                </li>
                
                <li class="toc-entry">
                    <a href=https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;posts&#x2F;toykio&#x2F;#gan-xie>æ„Ÿè°¢</a>
                    
    

                </li>
                
        </ul>
    

    </div>


                    </div>
                </aside>
            
    

            <main id="main">
                <div id="main-container">
                    
    
                    
    
    <article class="article-container container">
        
    <h1 class="title article-title">
        <a class="article-title-link" href="https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;posts&#x2F;toykio&#x2F;">
            
    <span class="draft-indicator">
        
    </span>
    <span>
        Futures-rs åšæ–‡ Toykio ç¿»è¯‘
    </span>

        </a>
    </h1>

        
    <time datetime=2018-08-18T18:24:51+08:00>2018-08-18 18:24</time>

        
    <div class="article-taxonomies"><span class="article-taxonomy"><a class="article-taxonomy-name" href="https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;tags">
                Tags</a><span class="article-terms"><a class="article-term-name" href="https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;tags&#x2F;rust&#x2F;">Rust</a><a class="article-term-name" href="https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;tags&#x2F;future&#x2F;">Future</a></span></span><span class="article-taxonomy"><a class="article-taxonomy-name" href="https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;categories">
                Categories</a><span class="article-terms"><a class="article-term-name" href="https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;categories&#x2F;fan-yi&#x2F;">ç¿»è¯‘</a></span></span></div>

        
    
        <section class="article-license">
            
                <div class="license-image">
                    <img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="Creative Commons License" />
                </div>
            
            <small class="license">This work is licensed under a <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a></small>
        </section>
    

        <section class="article-content"><p>æœ¬æ–‡ä¸º Rust futures-rs åšå®¢ 2018 å¹´ 8 æœˆ 17 æ—¥ çš„ åšæ–‡ <a href="https://rust-lang-nursery.github.io/futures-rs/blog/2018/08/17/toykio.html">Toykio</a> çš„ä¸­æ–‡ç¿»è¯‘ã€‚</p>
<p>åŸæ–‡ä½œè€… Alexander Polakovï¼ˆ<a href="https://github.com/polachok">@polachok</a>ï¼‰ã€‚</p>
<p>åŸæ–‡ç›®å‰ï¼ˆ2018-08-21ï¼‰ä¸ºå¯é€‰çš„ MIT å’Œ Apache æˆæƒï¼Œæœ¬æ–‡ä½¿ç”¨äº†å…¶ MIT æˆæƒã€‚<a href="https://github.com/linyinfeng/blog/tree/master/content/posts/toykio/LICENSE-MIT">MIT è®¸å¯è¯å‰¯æœ¬</a>ã€‚</p>
<p id="zola-continue-reading"><a name="continue-reading"></a></p>
<p>åœ¨è¿™ä¸ªåšæ–‡ä¸­æˆ‘å°†å±•ç¤º toykioï¼Œä¸€ä¸ªç”¨äºå­¦ä¹ å¸¦æœ‰äº‹ä»¶å¾ªç¯çš„ executor å¦‚ä½•å·¥ä½œçš„ç®€å• futures executorã€‚Toykio ä»…ä»…æä¾›å¾ˆå°‘çš„ç‰¹æ€§ï¼šä¸€ä¸ªäº‹ä»¶å¾ªç¯ä»¥åŠ TCP æµå’Œç›‘å¬å™¨ã€‚ä½†æ˜¯äº‹å®è¯æ˜ï¼Œç”±äº futures æ˜¯å¯ç»„åˆçš„ï¼Œè¿™å·²ç»è¶³å¤Ÿç”¨æ¥æ„å»ºå¤æ‚çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç¨‹åºã€‚</p>
<p>åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘å°†å‘ä½ æä¾› toykio ç»„ä»¶çš„å¿«é€Ÿæ¦‚è¿°ã€‚</p>
<h1 id="asynctcpstream"><a class="zola-anchor" href="#asynctcpstream" aria-label="Anchor link for: asynctcpstream">ğŸ”—</a><code>AsyncTcpStream</code></h1>
<p>Toykio å®šä¹‰äº† <code>AsyncTcpStream</code> ç±»å‹ï¼Œè¿™æ˜¯ä¸€ä¸ªæ ‡å‡†åº“ä¸­çš„ <code>TcpStream</code> çš„åŒ…è£…ã€‚å°±åƒæ ‡å‡†åº“ä¸­çš„ <code>TcpStream</code> ä¸€æ ·ï¼Œ<code>connect</code> å‡½æ•°æ‰“å¼€ä¸€ä¸ªè¿æ¥å¹¶å°† socket è®¾ä¸ºéé˜»å¡æ¨¡å¼ã€‚è¿™æ„å‘³ç€ <code>read()</code> å’Œ <code>write()</code> æ–¹æ³•å°†ä¼šç«‹åˆ»è¿”å›æ•°æ®æˆ–è€…é”™è¯¯ã€‚å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®ï¼ˆå¯¹äºè¯»æ“ä½œï¼‰æˆ–è€…ç¼“å†²åŒºç©ºé—´ï¼ˆå¯¹äºå†™æ“ä½œï¼‰ï¼Œä¸€ä¸ªç‰¹æ®Šçš„é”™è¯¯ <code>WouldBlock</code> å°†è¢«è¿”å›ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­è®¨è®ºå¦‚ä½•å¤„ç†å®ƒã€‚</p>
<h1 id="asyncread-he-asyncwrite"><a class="zola-anchor" href="#asyncread-he-asyncwrite" aria-label="Anchor link for: asyncread-he-asyncwrite">ğŸ”—</a><code>AsyncRead</code> å’Œ <code>AsyncWrite</code></h1>
<p><code>AsyncRead</code> å’Œ <code>AsyncWrite</code> traits æ˜¯æ‰€æœ‰ I/O ç‰¹æ€§çš„åŸºç¡€ã€‚<code>AsyncReadExt</code> å’Œ <code>AsyncWriteExt</code> çš„æ‰©å±•æ–¹æ³•ï¼ˆå¦‚ <code>read</code> å’Œ <code>write_all</code>ï¼‰å‡åœ¨å…¶ä¸Šæ„å»ºã€‚è¿™äº› traits æä¾›äº†ä¸€ç§ futures ä¸äº‹ä»¶å¾ªç¯è¿æ¥çš„æ–¹æ³•ï¼ŒåŒæ—¶ä¿è¯å®ƒä»¬ç‹¬ç«‹äºä»»ä½•ç‰¹å®šçš„äº‹ä»¶å¾ªç¯å®ç°ã€‚</p>
<p>è®©æˆ‘ä»¬çœ‹çœ‹ä¸º <code>AsyncTcpStream</code> å®ç° <code>AsyncRead</code> çš„æ–¹æ³•ï¼š</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">impl </span><span style="color:#c0c5ce;">AsyncRead </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">AsyncTcpStream {
    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">poll_read</span><span style="color:#c0c5ce;">(&amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">cx</span><span style="color:#c0c5ce;">: &amp;</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> Context, </span><span style="color:#bf616a;">buf</span><span style="color:#c0c5ce;">: &amp;</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> [</span><span style="color:#b48ead;">u8</span><span style="color:#c0c5ce;">]) -&gt; Poll&lt;Result&lt;</span><span style="color:#b48ead;">usize</span><span style="color:#c0c5ce;">, Error&gt;&gt; {
        </span><span style="color:#b48ead;">match </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">0.</span><span style="color:#96b5b4;">read</span><span style="color:#c0c5ce;">(buf) {
            Ok(len) =&gt; Poll::Ready(Ok(len)),
            Err(</span><span style="color:#b48ead;">ref</span><span style="color:#c0c5ce;"> err) </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;"> err.</span><span style="color:#96b5b4;">kind</span><span style="color:#c0c5ce;">() == std::io::ErrorKind::WouldBlock =&gt; {
                </span><span style="color:#65737e;">// è·å– TcpStream æ–‡ä»¶æè¿°ç¬¦
                </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> fd = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">0.</span><span style="color:#96b5b4;">as_raw_fd</span><span style="color:#c0c5ce;">();
                </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> waker = cx.</span><span style="color:#96b5b4;">waker</span><span style="color:#c0c5ce;">();

                </span><span style="color:#d08770;">REACTOR</span><span style="color:#c0c5ce;">.</span><span style="color:#96b5b4;">with</span><span style="color:#c0c5ce;">(|</span><span style="color:#bf616a;">reactor</span><span style="color:#c0c5ce;">| reactor.</span><span style="color:#96b5b4;">add_read_interest</span><span style="color:#c0c5ce;">(fd, waker.</span><span style="color:#96b5b4;">clone</span><span style="color:#c0c5ce;">()));

                Poll::Pending
            }
            Err(err) =&gt; panic!(&quot;</span><span style="color:#a3be8c;">error {:?}</span><span style="color:#c0c5ce;">&quot;, err),
        }
    }
}
</span></pre>
<p>å®ƒå°è¯•ä»åº•å±‚çš„ <code>TcpStream</code> è¯»å–ã€‚å¦‚æœè¯»å–æˆåŠŸäº†ï¼Œåˆ‡ç‰‡å°†è¢«å¡«ä¸Šæ•°æ®ã€‚å¦‚æœå¤±è´¥å¹¶ä¸”è¿”å›äº† <code>WouldBlock</code> é”™è¯¯ï¼Œå°±å°†å½“å‰ä»»åŠ¡çš„å”¤é†’å™¨æ³¨å†Œï¼Œè¿™æ ·å®ƒå°†åœ¨æ•°æ®å¯ç”¨çš„æ—¶å€™è¢«å”¤é†’ã€‚ä¸‹ä¸€èŠ‚ä¸­å°†æåˆ°æ›´å¤šæœ‰å…³çš„ç»†èŠ‚ã€‚</p>
<p><code>AsyncWrite</code> çš„å®ç°å¯¹ <code>write</code> åšäº†ç±»ä¼¼çš„äº‹ã€‚</p>
<h1 id="shi-jian-xun-huan"><a class="zola-anchor" href="#shi-jian-xun-huan" aria-label="Anchor link for: shi-jian-xun-huan">ğŸ”—</a>äº‹ä»¶å¾ªç¯</h1>
<p><code>Eventloop</code>ï¼ˆé€šå¸¸ä¹Ÿè¢«å«åš reactorï¼‰æ˜¯è¿™ä¸ª executor çš„æ ¸å¿ƒã€‚å®ƒåƒè¿™æ ·è¢«å®šä¹‰ï¼š</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">InnerEventLoop {
    </span><span style="color:#bf616a;">read</span><span style="color:#c0c5ce;">: RefCell&lt;BTreeMap&lt;RawFd, Waker&gt;&gt;,
    </span><span style="color:#bf616a;">write</span><span style="color:#c0c5ce;">: RefCell&lt;BTreeMap&lt;RawFd, Waker&gt;&gt;,
    </span><span style="color:#bf616a;">counter</span><span style="color:#c0c5ce;">: Cell&lt;</span><span style="color:#b48ead;">usize</span><span style="color:#c0c5ce;">&gt;,
    </span><span style="color:#bf616a;">wait_queue</span><span style="color:#c0c5ce;">: RefCell&lt;BTreeMap&lt;TaskId, Task&gt;&gt;,
    </span><span style="color:#bf616a;">run_queue</span><span style="color:#c0c5ce;">: RefCell&lt;VecDeque&lt;Wakeup&gt;&gt;,
}
</span></pre>
<ul>
<li><code>read</code> å’Œ <code>write</code> æ˜¯ <code>BTreeMaps</code>ï¼Œå°†æ–‡ä»¶æè¿°ç¬¦æ˜ å°„åˆ°å”¤é†’å™¨ã€‚</li>
<li><code>wait_queue</code> ä¿å­˜äº†é˜»å¡çš„ç­‰å¾…äº‹ä»¶çš„ä»»åŠ¡ã€‚</li>
<li><code>run_queue</code> ä¿å­˜äº†å”¤é†’æ¶ˆæ¯ã€‚</li>
</ul>
<p>äº‹ä»¶å¾ªç¯æä¾›äº†åœ¨ <code>read</code> å’Œ <code>write</code> äº‹ä»¶ä¸­æ³¨å†Œï¼ˆå’Œç§»é™¤ï¼‰å…´è¶£çš„æ–¹æ³•ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ <code>add_read_interest</code> åšäº†ä»€ä¹ˆï¼š</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">add_read_interest</span><span style="color:#c0c5ce;">(&amp;</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">fd</span><span style="color:#c0c5ce;">: RawFd, </span><span style="color:#bf616a;">waker</span><span style="color:#c0c5ce;">: Waker) {
    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">!</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.read.</span><span style="color:#96b5b4;">borrow</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">contains_key</span><span style="color:#c0c5ce;">(&amp;fd) {
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.read.</span><span style="color:#96b5b4;">borrow_mut</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">insert</span><span style="color:#c0c5ce;">(fd, waker);
    }
}
</span></pre>
<p>ä½†å®ƒä»…ä»…æ˜¯æŠŠ <code>fd</code> å’Œ <code>waker</code> æ’å…¥åˆ° <code>read</code> æ ‘ä¸­ï¼æ‰€æœ‰çš„é­”æ³•åˆ°åº•å‘ç”Ÿåœ¨å“ªé‡Œï¼Ÿåœ¨ä¸»å¾ªç¯ä¸­ã€‚äº‹ä»¶å¾ªç¯è¢«å«åšå¾ªç¯æ˜¯æœ‰åŸå› çš„ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ï¼š</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">loop </span><span style="color:#c0c5ce;">{
    </span><span style="color:#65737e;">// äº‹ä»¶å¾ªç¯è¿­ä»£è¶…æ—¶ã€‚å¦‚æœæ²¡æœ‰æè¿°ç¬¦å°±ç»ªæˆ‘ä»¬ä¹Ÿç»§ç»­è¿­ä»£ã€‚
    </span><span style="color:#b48ead;">let mut</span><span style="color:#c0c5ce;"> tv: timeval = timeval {
        tv_sec: </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">,
        tv_usec: </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
    };

    </span><span style="color:#65737e;">// åˆå§‹åŒ– fd_setsï¼ˆæ–‡ä»¶æè¿°ç¬¦é›†ï¼‰
    </span><span style="color:#b48ead;">let mut</span><span style="color:#c0c5ce;"> read_fds: fd_set = </span><span style="color:#b48ead;">unsafe </span><span style="color:#c0c5ce;">{ std::mem::zeroed() };
    </span><span style="color:#b48ead;">let mut</span><span style="color:#c0c5ce;"> write_fds: fd_set = </span><span style="color:#b48ead;">unsafe </span><span style="color:#c0c5ce;">{ std::mem::zeroed() };

    </span><span style="color:#b48ead;">unsafe </span><span style="color:#c0c5ce;">{ </span><span style="color:#d08770;">FD_ZERO</span><span style="color:#c0c5ce;">(&amp;</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> read_fds) };
    </span><span style="color:#b48ead;">unsafe </span><span style="color:#c0c5ce;">{ </span><span style="color:#d08770;">FD_ZERO</span><span style="color:#c0c5ce;">(&amp;</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> write_fds) };
</span></pre>
<p>å””å“¦ï¼Œè¿™é‡Œæœ‰éå¸¸å¤šçš„ <code>unsafe</code>ï¼ä½†æ˜¯åˆ«æ‹…å¿ƒï¼Œè¿™å°±æ˜¯ C FFI çš„å·¥ä½œæ–¹å¼ã€‚æˆ‘ä»¬éœ€è¦åˆå§‹åŒ–ä¸€äº› C ç»“æ„ä½“ï¼Œä¸€ä¸ªè¶…æ—¶å’Œ <code>fd_set</code>sã€‚å®ƒä»¬åé¢å°†è¢«ä¼ é€’ç»™ select(2) å‡½æ•°ã€‚</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// å°†æ‰€æœ‰è¯»å…´è¶£åŠ å…¥åˆ°è¯» fd_sets
    </span><span style="color:#b48ead;">for</span><span style="color:#c0c5ce;"> fd in </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.read.</span><span style="color:#96b5b4;">borrow</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">keys</span><span style="color:#c0c5ce;">() {
        </span><span style="color:#b48ead;">unsafe </span><span style="color:#c0c5ce;">{ </span><span style="color:#d08770;">FD_SET</span><span style="color:#c0c5ce;">(*fd, &amp;</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> read_fds as </span><span style="color:#b48ead;">*mut</span><span style="color:#c0c5ce;"> fd_set) };
        nfds = std::cmp::max(nfds, fd + </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);
    }

    </span><span style="color:#65737e;">// å°†æ‰€æœ‰å†™å…´è¶£åŠ å…¥åˆ°å†™ fd_sets
    </span><span style="color:#b48ead;">for</span><span style="color:#c0c5ce;"> fd in </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.write.</span><span style="color:#96b5b4;">borrow</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">keys</span><span style="color:#c0c5ce;">() {
        </span><span style="color:#b48ead;">unsafe </span><span style="color:#c0c5ce;">{ </span><span style="color:#d08770;">FD_SET</span><span style="color:#c0c5ce;">(*fd, &amp;</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> write_fds as </span><span style="color:#b48ead;">*mut</span><span style="color:#c0c5ce;"> fd_set) };
        nfds = std::cmp::max(nfds, fd + </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);
    }
</span></pre>
<p>è¿™é‡Œæˆ‘ä»¬å°†ä¹‹å‰ <code>read</code> å’Œ <code>write</code> maps ä¸­çš„æ–‡ä»¶æè¿°ç¬¦ç½®å…¥åˆ° <code>fd_set</code>s ä¸­ã€‚</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// `select` å°†é˜»å¡åˆ°æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰ä¸€äº›äº‹ä»¶å‘ç”Ÿæˆ–è€…è¶…æ—¶
    </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> rv = </span><span style="color:#b48ead;">unsafe </span><span style="color:#c0c5ce;">{
        </span><span style="color:#96b5b4;">select</span><span style="color:#c0c5ce;">(
            nfds,
            &amp;</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> read_fds,
            &amp;</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> write_fds,
            std::ptr::null_mut(),
            &amp;</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> tv,
        )
    };

    </span><span style="color:#65737e;">// ä¸åœ¨ä¹é”™è¯¯
    </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;"> rv == -</span><span style="color:#d08770;">1 </span><span style="color:#c0c5ce;">{
        panic!(&quot;</span><span style="color:#a3be8c;">select()</span><span style="color:#c0c5ce;">&quot;);
    } </span><span style="color:#b48ead;">else if</span><span style="color:#c0c5ce;"> rv == </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">{
        debug!(&quot;</span><span style="color:#a3be8c;">timeout</span><span style="color:#c0c5ce;">&quot;);
    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
        debug!(&quot;</span><span style="color:#a3be8c;">data available on {} fds</span><span style="color:#c0c5ce;">&quot;, rv);
    }
</span></pre>
<p>ç»ˆäºæˆ‘ä»¬ä½¿ç”¨å‡†å¤‡çš„å‚æ•°è°ƒç”¨äº† <code>select</code>ã€‚<code>select()</code> æ¥å— 3 ä¸ª <code>fd_set</code>sï¼ˆæˆ‘ä»¬åœ¨è¿™ä¸ªä¾‹å­ä¸­å¿½ç•¥äº†ç¬¬ä¸‰ä¸ªï¼‰å’Œä¸€ä¸ªè¶…æ—¶å¹¶ä¸”è¿”å›ä¸€äº›é 0 å€¼å¦‚æœä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰é›†åˆä¸­çš„æ–‡ä»¶æ ‡è¯†ç¬¦å°±ç»ªäº†ã€‚æˆ‘ä»¬åº”è¯¥éšåæ‰¾åˆ°æ˜¯å“ªäº›æ–‡ä»¶æ ‡è¯†ç¬¦ï¼</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// æ£€æŸ¥æ˜¯å“ªäº›æ–‡ä»¶æ ‡è¯†ç¬¦å¹¶å°†åˆé€‚çš„ future ç½®å…¥ run é˜Ÿåˆ—
    </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(fd, waker) in </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.read.</span><span style="color:#96b5b4;">borrow</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">iter</span><span style="color:#c0c5ce;">() {
        </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> is_set = </span><span style="color:#b48ead;">unsafe </span><span style="color:#c0c5ce;">{ </span><span style="color:#d08770;">FD_ISSET</span><span style="color:#c0c5ce;">(*fd, &amp;</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> read_fds as </span><span style="color:#b48ead;">*mut</span><span style="color:#c0c5ce;"> fd_set) };
        </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;"> is_set {
            waker.</span><span style="color:#96b5b4;">wake</span><span style="color:#c0c5ce;">();
        }
    }

    </span><span style="color:#65737e;">// å¯¹ write åšä¸€æ ·çš„äº‹
    </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(fd, waker) in </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.write.</span><span style="color:#96b5b4;">borrow</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">iter</span><span style="color:#c0c5ce;">() {
        </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> is_set = </span><span style="color:#b48ead;">unsafe </span><span style="color:#c0c5ce;">{ </span><span style="color:#d08770;">FD_ISSET</span><span style="color:#c0c5ce;">(*fd, &amp;</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> write_fds as </span><span style="color:#b48ead;">*mut</span><span style="color:#c0c5ce;"> fd_set) };
        </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;"> is_set {
            waker.</span><span style="color:#96b5b4;">wake</span><span style="color:#c0c5ce;">();
        }
    }
</span></pre>
<p>æˆ‘ä»¬å†æ¬¡éå†äº†æˆ‘ä»¬çš„ map å¹¶æ£€æŸ¥å®ƒä»¬æ˜¯å¦åœ¨ <code>fd_set</code>s ä¸­è¢«è®¾ä¸ºå°±ç»ªã€‚å½“å®ƒä»¬è¢«è®¾ä¸ºå°±ç»ªï¼Œæˆ‘ä»¬å°±è°ƒç”¨å®ƒä»¬å…³è”çš„å”¤é†’å™¨çš„ wake æ–¹æ³•ï¼Œè¿™å°†ä¼šæŠŠ Wakeup äº‹ä»¶ç½®äºå‡†å¤‡æ‰§è¡Œé˜Ÿåˆ—ä¸Šã€‚</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">let mut</span><span style="color:#c0c5ce;"> tasks_done = Vec::new();

    </span><span style="color:#65737e;">// ç°åœ¨ä» run é˜Ÿåˆ—ä¸­ pop ä»»åŠ¡å¹¶ poll å®ƒä»¬
    </span><span style="color:#b48ead;">while let </span><span style="color:#c0c5ce;">Some(wakeup) = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.run_queue.</span><span style="color:#96b5b4;">borrow_mut</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">pop_front</span><span style="color:#c0c5ce;">() {
        </span><span style="color:#b48ead;">let mut</span><span style="color:#c0c5ce;"> handle = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#96b5b4;">handle</span><span style="color:#c0c5ce;">();

        </span><span style="color:#b48ead;">if let </span><span style="color:#c0c5ce;">Some(</span><span style="color:#b48ead;">ref mut</span><span style="color:#c0c5ce;"> task) = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.wait_queue.</span><span style="color:#96b5b4;">borrow_mut</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">get_mut</span><span style="color:#c0c5ce;">(&amp;wakeup.index) {
            </span><span style="color:#65737e;">// å¦‚æœä¸€ä¸ªä»»åŠ¡è¿”å›äº† `Poll::Ready`, æˆ‘ä»¬å°±å®Œæˆäº†å®ƒ
            </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;"> task.</span><span style="color:#96b5b4;">poll</span><span style="color:#c0c5ce;">(wakeup.waker, &amp;</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> handle).</span><span style="color:#96b5b4;">is_ready</span><span style="color:#c0c5ce;">() {
                tasks_done.</span><span style="color:#96b5b4;">push</span><span style="color:#c0c5ce;">(wakeup.index);
            }
        }
    }

    </span><span style="color:#65737e;">// åˆ é™¤å·²ç»å®Œæˆçš„ä»»åŠ¡
    </span><span style="color:#b48ead;">for</span><span style="color:#c0c5ce;"> idx in tasks_done {
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.wait_queue.</span><span style="color:#96b5b4;">borrow_mut</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">remove</span><span style="color:#c0c5ce;">(&amp;idx);
    }

    </span><span style="color:#65737e;">// å¦‚æœ `wait_queue` ä¸­æ²¡æœ‰æ›´å¤šçš„ä»»åŠ¡ï¼Œåœæ­¢å¾ªç¯
    </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.wait_queue.</span><span style="color:#96b5b4;">borrow</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">is_empty</span><span style="color:#c0c5ce;">() {
        </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;">;
    }
</span></pre>
<p>æˆ‘ä»¬æ¶ˆè€—äº† <code>run_queue</code>ï¼Œè·å– <code>wait_queue</code> ä¸­çš„ä»»åŠ¡ç´¢å¼•å¹¶è¯¢é—®è¿™äº›ä»»åŠ¡ã€‚Ready(done) ä»»åŠ¡å°†ä» <code>wait_queue</code> ä¸­è¢«ç§»é™¤ã€‚</p>
<h1 id="yi-ge-future-de-yi-sheng"><a class="zola-anchor" href="#yi-ge-future-de-yi-sheng" aria-label="Anchor link for: yi-ge-future-de-yi-sheng">ğŸ”—</a>ä¸€ä¸ª future çš„ä¸€ç”Ÿ</h1>
<p>åœ¨è¿™èŠ‚ä¸­ï¼Œæˆ‘å°†æ¦‚æ‹¬ä¸€ä¸ª futureï¼ˆè®©æˆ‘ä»¬ä»¥ read ä¸ºä¾‹å­ï¼‰æ˜¯å¦‚ä½•åœ¨ eventloop ä¸­è¢«æ‰§è¡Œçš„ï¼š</p>
<ul>
<li>é¦–å…ˆå®ƒç”± <code>AsyncTcpStream</code> çš„ <code>read()</code> æ–¹æ³•åˆ›å»ºï¼Œè¿™ä¸ªæ–¹æ³•è¢«æ‰€æœ‰å®ç°äº† <code>AsyncRead</code> trait çš„ç±»å‹å®ç°ã€‚</li>
<li>ç„¶åä½¿ç”¨ <code>run()</code> æˆ– <code>spawn()</code> æ–¹æ³•åœ¨ executor ä¸­ spawn å®ƒã€‚</li>
<li>Executor è°ƒç”¨è¿™ä¸ª future çš„ poll æ–¹æ³•ã€‚Read ä¸­ <code>poll</code> çš„å®ç°è°ƒç”¨ <code>AsyncTcpStream</code> çš„ <code>poll_read()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°†å®ƒçš„å…´è¶£æ³¨å†Œåˆ° <code>readable</code> äº‹ä»¶ä¸­ã€‚</li>
<li>å½“ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿï¼Œfuture å°†è¢«å†æ¬¡ pollã€‚è¿™ä¸ªå¾ªç¯å°†è¢«é‡å¤ç›´åˆ° future è¿”å›äº† readyã€‚</li>
</ul>
<h1 id="gan-xie"><a class="zola-anchor" href="#gan-xie" aria-label="Anchor link for: gan-xie">ğŸ”—</a>æ„Ÿè°¢</h1>
<p>æ„Ÿè°¢ futures å›¢é˜Ÿçš„æ‰€æœ‰äººã€‚ç‰¹åˆ«æ„Ÿè°¢ <a href="https://github.com/aturon">@aturon</a> çš„é¼“åŠ±å’Œ <a href="https://github.com/MajorBreakfast">@MajorBreakfast</a> çš„ç¼–è¾‘ã€‚</p>
<p>è¿™å°±æ˜¯ä»Šå¤©çš„æ‰€æœ‰å†…å®¹ï¼ä½ å¯ä»¥åœ¨ <a href="https://github.com/polachok/toykio/tree/futures-0.3">github</a> å’Œ <a href="https://crates.io/crates/toykio">crates.io</a> ä¸Šæ‰¾åˆ° toykioã€‚Hacking å¿«ä¹ï¼</p>
</section>
    </article>


                </div>
            </main>
        </div>
        <footer id="footer">
            
            
    <div class="footer-container container">
        <div id="copyright-container">
            <small id="copyright">Â© Lin Yinfeng 2018-2019</small>
        </div>
        
        
            <div id="powered-by-container">
                <small id="powered-by">Powered by <a href="https://www.getzola.org">Zola</a></small>
            </div>
        
    </div>

            
        </footer>
    

    <script src=https:&#x2F;&#x2F;www.linyinfeng.com&#x2F;layout-helper.js></script>
</body>
</html>